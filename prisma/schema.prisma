generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Activity {
  id                             String          @id
  orderId                        String?
  vendorId                       String?
  customerId                     String?
  deliveryId                     String?
  type                           ActivityType
  title                          String
  message                        String
  meta                           Json?
  createdAt                      DateTime        @default(now())
  User_Activity_customerIdToUser User?           @relation("Activity_customerIdToUser", fields: [customerId], references: [id], onDelete: Cascade)
  DeliveryPerson                 DeliveryPerson? @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  Order                          Order?          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  User_Activity_vendorIdToUser   User?           @relation("Activity_vendorIdToUser", fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([orderId])
  @@index([type])
  @@index([vendorId])
}

model Address {
  id        String   @id
  userId    String
  label     String
  street    String
  city      String
  state     String?
  country   String
  zipCode   String?
  landmark  String?
  latitude  Float?
  longitude Float?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Order     Order[]

  @@index([isDefault])
  @@index([latitude, longitude])
}

model AuditLog {
  id         String   @id
  userId     String?
  action     String
  ipAddress  String
  userAgent  String
  deviceId   String?
  geoCity    String?
  geoRegion  String?
  geoCountry String?
  details    Json?
  path       String
  metadata   Json?
  createdAt  DateTime @default(now())
}

model Cart {
  id         String     @id
  customerId String
  basePrice  Float      @default(0)
  totalPrice Float      @default(0)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime
  User       User       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  CartItem   CartItem[]

  @@index([customerId])
}

model CartItem {
  id             String           @id
  cartId         String
  productId      String
  quantity       Int
  unitPrice      Float
  subtotal       Float
  specialRequest String?
  Cart           Cart             @relation(fields: [cartId], references: [id], onDelete: Cascade)
  Product        Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  CartItemOption CartItemOption[]
}

model CartItemOption {
  id              String        @id
  cartItemId      String
  productOptionId String
  name            String
  price           Float
  CartItem        CartItem      @relation(fields: [cartItemId], references: [id], onDelete: Cascade)
  ProductOption   ProductOption @relation(fields: [productOptionId], references: [id], onDelete: Cascade)

  @@index([cartItemId])
  @@index([productOptionId])
}

model DeliveryAssignment {
  id               String         @id
  orderId          String
  deliveryPersonId String
  status           DeliveryStatus @default(ASSIGNED)
  assignedAt       DateTime       @default(now())
  acceptedAt       DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  declinedAt       DateTime?
  timeoutSeconds   Int            @default(30)
  attempts         Int            @default(0)
  batchId          String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  DeliveryPerson   DeliveryPerson @relation(fields: [deliveryPersonId], references: [id], onDelete: Cascade)
  Order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([deliveryPersonId])
  @@index([orderId])
}

model DeliveryBroadcast {
  id               String   @id
  orderId          String
  driverIds        String[]
  acceptedDriverId String?
  status           String
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  Order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model DeliveryEarning {
  id               String         @id
  deliveryPersonId String
  orderId          String
  baseFee          Float
  distanceFee      Float
  tip              Float          @default(0)
  deductions       Float          @default(0)
  totalEarned      Float
  createdAt        DateTime       @default(now())
  DeliveryPerson   DeliveryPerson @relation(fields: [deliveryPersonId], references: [id])
  Order            Order          @relation(fields: [orderId], references: [id])
}

model DeliveryPerson {
  id                 String               @id
  userId             String               @unique
  vehicleType        String?
  licensePlate       String?
  status             String               @default("ACTIVE")
  rating             Float                @default(0)
  totalDeliveries    Int                  @default(0)
  isOnline           Boolean              @default(false)
  latitude           Float?
  longitude          Float?
  lastSeenAt         DateTime?
  walletBalance      Float                @default(0)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  Activity           Activity[]
  DeliveryAssignment DeliveryAssignment[]
  DeliveryEarning    DeliveryEarning[]
  User               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  DriverLocationLog  DriverLocationLog[]

  @@index([userId])
}

model DriverLocationLog {
  id             String         @id
  driverId       String
  latitude       Float
  longitude      Float
  timestamp      DateTime       @default(now())
  DeliveryPerson DeliveryPerson @relation(fields: [driverId], references: [id], onDelete: Cascade)
}

model LoginHistory {
  id         String   @id
  userId     String
  method     String
  deviceId   String?
  location   String?
  ip         String?
  userAgent  String?
  geoCity    String?
  geoRegion  String?
  geoCountry String?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Notification {
  id        String   @id
  userId    String
  title     String
  message   String
  type      String
  metadata  Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id                          String               @id
  customerId                  String
  vendorId                    String
  addressId                   String?
  basePrice                   Float
  extraCharge                 Float                @default(0)
  totalPrice                  Float
  vendorNote                  String?
  customerApproval            Boolean              @default(false)
  status                      OrderStatus          @default(PENDING)
  createdAt                   DateTime             @default(now())
  updatedAt                   DateTime             @default(now())
  paymentInitiatedAt          DateTime?
  paymentStartedAt            DateTime?
  paidAt                      DateTime?
  paymentStatus               PaymentStatus?       @default(PENDING)
  cancelledAt                 DateTime?
  cancellationReason          String?
  protectedUntil              DateTime?
  paymentGraceMinutes         Int?                 @default(15)
  Activity                    Activity[]
  DeliveryAssignment          DeliveryAssignment[]
  DeliveryBroadcast           DeliveryBroadcast[]
  DeliveryEarning             DeliveryEarning[]
  Address                     Address?             @relation(fields: [addressId], references: [id])
  User_Order_customerIdToUser User                 @relation("Order_customerIdToUser", fields: [customerId], references: [id], onDelete: Cascade)
  User_Order_vendorIdToUser   User                 @relation("Order_vendorIdToUser", fields: [vendorId], references: [id], onDelete: Cascade)
  OrderItem                   OrderItem[]
  Payment                     Payment[]
  Product                     Product[]            @relation("ProductOrders")

  @@index([customerId, createdAt])
  @@index([status])
  @@index([vendorId, createdAt])
}

model OrderItem {
  id              String            @id
  orderId         String
  productId       String
  quantity        Int
  unitPrice       Float
  subtotal        Float
  createdAt       DateTime          @default(now())
  Order           Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Product         Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  OrderItemOption OrderItemOption[]
}

model OrderItemOption {
  id            String        @id
  optionId      String
  name          String
  price         Float
  orderItemId   String
  ProductOption ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  OrderItem     OrderItem     @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([optionId])
  @@index([orderItemId])
}

model PasswordResetToken {
  userId    String   @id
  token     String
  expiresAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id           String    @id
  userId       String
  orderId      String
  amount       Int
  reference    String    @unique
  status       String
  paystackData Json?
  channel      String?
  ipAddress    String    @default("unknown")
  userAgent    String    @default("unknown")
  deviceId     String?
  geoCity      String?
  geoCountry   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())
  metadata     Json?
  startedAt    DateTime?
  completedAt  DateTime?
  expiresAt    DateTime?
  Order        Order     @relation(fields: [orderId], references: [id])
  User         User      @relation(fields: [userId], references: [id])
  Receipt      Receipt[]

  @@index([orderId])
  @@index([status])
  @@index([userId])
}

model Product {
  id                  String                   @id
  name                String
  description         String
  price               Float
  archived            Boolean                  @default(false)
  category            Category
  images              String[]
  thumbnail           String?
  video               String[]
  vendorId            String
  averageRating       Float?                   @default(0)
  reviewCount         Int                      @default(0)
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime
  totalViews          Int                      @default(0)
  popularityScore     Float                    @default(0)
  popularityUpdatedAt DateTime?
  popularityPercent   Float                    @default(0)
  isNew               Boolean                  @default(false)
  isLive              Boolean                  @default(false)
  liveUntil           DateTime?
  tsvector_col        Unsupported("tsvector")?
  CartItem            CartItem[]
  OrderItem           OrderItem[]
  User                User                     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  ProductOption       ProductOption[]
  ProductReview       ProductReview[]
  ProductSchedule     ProductSchedule?
  SpecialOrderRequest SpecialOrderRequest[]
  Order               Order[]                  @relation("ProductOrders")

  @@index([archived])
  @@index([createdAt])
  @@index([isLive])
  @@index([price])
  @@index([category], map: "product_category_idx")
  @@index([description(ops: raw("gin_trgm_ops"))], map: "product_description_trgm_idx", type: Gin)
  @@index([name], map: "product_name_idx")
  @@index([name(ops: raw("gin_trgm_ops"))], map: "product_name_trgm_idx", type: Gin)
  @@index([tsvector_col], map: "product_tsv_idx", type: Gin)
  @@index([vendorId], map: "product_vendor_idx")
}

model ProductOption {
  id              String            @id
  productId       String
  name            String
  price           Float
  CartItemOption  CartItemOption[]
  OrderItemOption OrderItemOption[]
  Product         Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductReview {
  id               String         @id
  productId        String
  customerId       String
  rating           Int
  comment          String?
  images           String[]
  createdAt        DateTime       @default(now())
  verifiedPurchase Boolean        @default(false)
  User             User           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  Product          Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  ReviewReport     ReviewReport[]
  ReviewVote       ReviewVote[]
  VendorReply      VendorReply?

  @@index([customerId])
  @@index([productId, createdAt])
}

model ProductSchedule {
  id                 String    @id
  productId          String    @unique
  goLiveAt           DateTime?
  takeDownAt         DateTime?
  isLive             Boolean   @default(false)
  graceMinutes       Int?      @default(0)
  autoGraceEnabled   Boolean   @default(false)
  manualGraceEnabled Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  Product            Product   @relation(fields: [productId], references: [id])
}

model Receipt {
  id        String   @id
  paymentId String
  pdfUrl    String?
  createdAt DateTime @default(now())
  Payment   Payment  @relation(fields: [paymentId], references: [id])
}

model RefundRequest {
  id         String       @id
  userId     String
  paymentRef String
  reason     String
  status     RefundStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime
  User       User         @relation(fields: [userId], references: [id])
}

model ReviewReport {
  id            String        @id
  reviewId      String
  userId        String
  reason        String
  createdAt     DateTime      @default(now())
  ProductReview ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReviewVote {
  id            String        @id
  reviewId      String
  userId        String
  isHelpful     Boolean
  createdAt     DateTime      @default(now())
  ProductReview ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
}

model SpecialOrderOffer {
  id                  String              @id
  requestId           String
  vendorId            String
  price               Float
  message             String?
  status              String              @default("PENDING")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  SpecialOrderRequest SpecialOrderRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  User                User                @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model SpecialOrderRequest {
  id                                        String              @id
  customerId                                String
  vendorId                                  String?
  productId                                 String
  quantity                                  Int
  message                                   String
  status                                    String              @default("PENDING")
  createdAt                                 DateTime            @default(now())
  updatedAt                                 DateTime
  SpecialOrderOffer                         SpecialOrderOffer[]
  User_SpecialOrderRequest_customerIdToUser User                @relation("SpecialOrderRequest_customerIdToUser", fields: [customerId], references: [id], onDelete: Cascade)
  Product                                   Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  User_SpecialOrderRequest_vendorIdToUser   User?               @relation("SpecialOrderRequest_vendorIdToUser", fields: [vendorId], references: [id], onDelete: Cascade)
}

model User {
  id                                                       String                @id
  username                                                 String?               @unique
  name                                                     String
  email                                                    String                @unique
  phoneNumber                                              String?
  password                                                 String?
  avatarUrl                                                String?
  preferences                                              String[]
  bio                                                      String?
  role                                                     Role?
  brandName                                                String?
  brandLogo                                                String?
  googleId                                                 String?               @unique
  tokenVersion                                             Int                   @default(0)
  createdAt                                                DateTime              @default(now())
  updatedAt                                                DateTime
  authProviders                                            String[]
  lastLoginAt                                              DateTime?
  loginMethod                                              String?
  isEmailVerified                                          Boolean               @default(false)
  emailVerificationToken                                   String?
  emailVerificationExpiresAt                               DateTime?
  Activity_Activity_customerIdToUser                       Activity[]            @relation("Activity_customerIdToUser")
  Activity_Activity_vendorIdToUser                         Activity[]            @relation("Activity_vendorIdToUser")
  Address                                                  Address[]
  Cart                                                     Cart[]
  DeliveryPerson                                           DeliveryPerson?
  LoginHistory                                             LoginHistory[]
  Notification                                             Notification[]
  Order_Order_customerIdToUser                             Order[]               @relation("Order_customerIdToUser")
  Order_Order_vendorIdToUser                               Order[]               @relation("Order_vendorIdToUser")
  PasswordResetToken                                       PasswordResetToken?
  Payment                                                  Payment[]
  Product                                                  Product[]
  ProductReview                                            ProductReview[]
  RefundRequest                                            RefundRequest[]
  ReviewReport                                             ReviewReport[]
  ReviewVote                                               ReviewVote[]
  SpecialOrderOffer                                        SpecialOrderOffer[]
  SpecialOrderRequest_SpecialOrderRequest_customerIdToUser SpecialOrderRequest[] @relation("SpecialOrderRequest_customerIdToUser")
  SpecialOrderRequest_SpecialOrderRequest_vendorIdToUser   SpecialOrderRequest[] @relation("SpecialOrderRequest_vendorIdToUser")
  UserPaymentMethod                                        UserPaymentMethod[]
  VendorFollower_VendorFollower_customerIdToUser           VendorFollower[]      @relation("VendorFollower_customerIdToUser")
  VendorFollower_VendorFollower_vendorIdToUser             VendorFollower[]      @relation("VendorFollower_vendorIdToUser")
  VendorReply                                              VendorReply[]
  VendorReview_VendorReview_customerIdToUser               VendorReview[]        @relation("VendorReview_customerIdToUser")
  VendorReview_VendorReview_vendorIdToUser                 VendorReview[]        @relation("VendorReview_vendorIdToUser")
}

model UserPaymentMethod {
  id        String   @id
  userId    String
  cardToken String   @unique
  last4     String
  brand     String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id])
}

model VendorFollower {
  id                                   String   @id
  vendorId                             String
  customerId                           String
  createdAt                            DateTime @default(now())
  User_VendorFollower_customerIdToUser User     @relation("VendorFollower_customerIdToUser", fields: [customerId], references: [id], onDelete: Cascade)
  User_VendorFollower_vendorIdToUser   User     @relation("VendorFollower_vendorIdToUser", fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, customerId])
  @@index([customerId])
  @@index([vendorId])
}

model VendorReply {
  id            String        @id
  reviewId      String        @unique
  vendorId      String
  message       String
  createdAt     DateTime      @default(now())
  ProductReview ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model VendorReview {
  id                                 String   @id
  vendorId                           String
  customerId                         String
  rating                             Int
  comment                            String?
  createdAt                          DateTime @default(now())
  User_VendorReview_customerIdToUser User     @relation("VendorReview_customerIdToUser", fields: [customerId], references: [id], onDelete: Cascade)
  User_VendorReview_vendorIdToUser   User     @relation("VendorReview_vendorIdToUser", fields: [vendorId], references: [id], onDelete: Cascade)
}

model WebhookEvent {
  id          String    @id
  reference   String
  event       String
  payload     Json
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@unique([reference, event])
}

enum ActivityType {
  ORDER_CREATED
  PAYMENT_SUCCESS
  NEW_PAID_ORDER
  REFUND_REQUESTED
  REFUND_ISSUED
  REVIEW_POSTED
  DELIVERY_ASSIGNED
  DELIVERY_COMPLETED
  ORDER_EXPIRED
  ORDER_CANCELLED
  GENERAL
}

enum BroadcastStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum Category {
  BREAKFAST
  LUNCH
  DINNER
  DESSERT
  DRINK
}

enum DeliveryStatus {
  ASSIGNED
  ACCEPTED
  DECLINED
  PICKED_UP
  EN_ROUTE
  DELIVERED
  FAILED
  RETURNED
  CANCELLED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum OrderStatus {
  PENDING
  WAITING_VENDOR_CONFIRMATION
  WAITING_CUSTOMER_APPROVAL
  AWAITING_PAYMENT
  PAYMENT_CONFIRMED
  COOKING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  COMPLETED
  CANCELLED
  FAILED_DELIVERY
  PAYMENT_EXPIRED
  CANCELLED_UNPAID
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  EXPIRED
  REFUNDED
  INITIATED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum RequestStatus {
  PENDING
  OFFER_MADE
  ACCEPTED
  REJECTED
  CANCELLED
}

enum Role {
  CUSTOMER
  VENDOR
  ADMIN
  DELIVERY
}
